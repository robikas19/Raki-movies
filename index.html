<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸŽ¬ Raki Movie Explorer Pro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              600: '#2563eb',
              700: '#1d4ed8',
            },
            secondary: {
              500: '#eab308',
              600: '#ca8a04',
            },
            dark: {
              800: '#1e293b',
              900: '#0f172a',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
          }
        }
      }
    }
  </script>
  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }
    ::-webkit-scrollbar-thumb {
      background: #3b82f6;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #2563eb;
    }
    
    /* Spinner */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: #3b82f6;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Modal backdrop */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
    }
    
    /* Card hover effect */
    .movie-card {
      transition: all 0.3s ease;
      transform-style: preserve-3d;
    }
    .movie-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    /* Rating badge */
    .rating-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
      font-size: 0.8rem;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: 2px solid;
    }
    
    /* Typewriter effect */
    .typewriter {
      overflow: hidden;
      border-right: 3px solid #3b82f6;
      white-space: nowrap;
      margin: 0 auto;
      letter-spacing: 0.15em;
      animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
    }
    @keyframes typing {
      from { width: 0 }
      to { width: 100% }
    }
    @keyframes blink-caret {
      from, to { border-color: transparent }
      50% { border-color: #3b82f6; }
    }
    
    /* Gradient text */
    .gradient-text {
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    /* Floating action button */
    .fab {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      z-index: 20;
      transition: all 0.3s ease;
    }
    .fab:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body class="bg-dark-900 text-white min-h-screen flex flex-col items-center p-4 md:p-6 transition-colors duration-300" data-theme="dark">

  <!-- Floating action button for quick search -->
  <button id="quickSearchBtn" class="fab bg-primary-600 hover:bg-primary-700 hidden md:flex" aria-label="Quick search">
    <i class="fas fa-search text-white text-xl"></i>
  </button>

  <header class="max-w-6xl w-full mb-8 text-center animate-fade-in">
    <h1 class="text-4xl md:text-5xl font-extrabold mb-2 select-none">
      <span class="gradient-text">ðŸŽ¬ Raki Movie Explorer Pro</span>
    </h1>
    <p class="text-gray-400 select-none">
      Discover, explore, and save your favorite movies powered by 
      <a href="https://www.themoviedb.org/" target="_blank" rel="noopener" class="underline text-blue-400 hover:text-blue-300">TMDb API</a>
    </p>
  </header>

  <!-- Theme toggle and search controls -->
  <div class="max-w-6xl w-full mb-6 flex flex-col sm:flex-row gap-4 justify-between items-center animate-slide-up">
    <div class="flex items-center gap-4">
      <!-- Dark/Light toggle -->
      <button id="toggleTheme" aria-label="Toggle dark/light mode"
        class="p-3 bg-gray-800 rounded-full hover:bg-gray-700 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md">
        <i class="fas fa-moon text-yellow-400"></i>
      </button>
      
      <!-- Genre filter dropdown -->
      <div class="relative">
        <button id="genreFilterBtn" class="px-4 py-2 bg-gray-800 rounded-md hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center gap-2">
          <i class="fas fa-filter"></i>
          <span>Genres</span>
          <i class="fas fa-chevron-down text-xs"></i>
        </button>
        <div id="genreDropdown" class="absolute left-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg z-10 hidden overflow-y-auto max-h-96">
          <!-- Genres will be populated here -->
        </div>
      </div>
    </div>
    
    <!-- Search input and buttons -->
    <div class="flex-grow max-w-2xl flex flex-col sm:flex-row gap-4">
      <div class="relative flex-grow">
        <input
          id="searchInput"
          type="search"
          placeholder="Search for movies..."
          class="w-full p-3 pl-10 rounded-md bg-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white shadow-md"
          autocomplete="off"
          spellcheck="false"
          aria-label="Search movies"
        />
        <i class="fas fa-search absolute left-3 top-3.5 text-gray-500"></i>
      </div>
      <div class="flex gap-2">
        <button id="showFavoritesBtn" class="px-4 py-3 bg-secondary-500 rounded-md hover:bg-secondary-600 transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-400 flex items-center gap-2 shadow-md">
          <i class="fas fa-star"></i>
          <span class="hidden sm:inline">Favorites</span>
        </button>
        <button id="clearSearchBtn" class="px-4 py-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 flex items-center gap-2 shadow-md">
          <i class="fas fa-times"></i>
          <span class="hidden sm:inline">Clear</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Sort controls -->
  <div class="max-w-6xl w-full mb-4 flex justify-end animate-slide-up">
    <div class="flex items-center gap-2">
      <span class="text-gray-400 text-sm">Sort by:</span>
      <select id="sortSelect" class="bg-gray-800 text-white p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm shadow-md">
        <option value="popularity.desc">Popularity</option>
        <option value="vote_average.desc">Rating</option>
        <option value="release_date.desc">Newest</option>
        <option value="release_date.asc">Oldest</option>
        <option value="revenue.desc">Revenue</option>
      </select>
    </div>
  </div>

  <!-- Main content area -->
  <main class="max-w-6xl w-full flex-grow">
    <!-- Stats bar -->
    <div id="statsBar" class="bg-gray-800 rounded-lg p-3 mb-6 flex flex-wrap justify-between items-center text-sm text-gray-300 hidden animate-fade-in">
      <div class="flex items-center gap-2">
        <i class="fas fa-film"></i>
        <span id="totalResults">0 movies found</span>
      </div>
      <div class="flex items-center gap-2">
        <i class="fas fa-clock"></i>
        <span id="searchTime">0.00s</span>
      </div>
      <div class="flex items-center gap-2">
        <i class="fas fa-calendar"></i>
        <span id="yearRange">All years</span>
      </div>
    </div>

    <!-- Movies grid -->
    <div id="moviesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" aria-live="polite" aria-atomic="true"></div>

    <!-- Loading indicator -->
    <div id="loading" class="my-10 hidden">
      <div class="spinner" role="status" aria-label="Loading"></div>
      <p class="text-center mt-4 text-gray-400">Loading movies...</p>
    </div>

    <!-- No results message -->
    <div id="noResults" class="text-center mt-10 hidden animate-fade-in" role="alert">
      <i class="fas fa-film text-5xl text-gray-600 mb-4"></i>
      <h3 class="text-xl font-semibold text-gray-300 mb-2">No movies found</h3>
      <p class="text-gray-500 max-w-md mx-auto">Try adjusting your search or filters. Maybe check out our <a href="#" id="popularLink" class="text-blue-400 hover:underline">popular movies</a> instead?</p>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-8 mb-12">
      <button id="prevBtn" class="px-5 py-2 bg-primary-600 rounded-md hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 flex items-center gap-2 shadow-md" disabled aria-label="Previous page">
        <i class="fas fa-chevron-left"></i>
        <span>Previous</span>
      </button>
      <div class="flex items-center gap-2">
        <span id="pageInfo" class="text-gray-400 text-sm" aria-live="polite"></span>
        <div class="hidden sm:block text-gray-500">|</div>
        <span id="totalPages" class="text-gray-400 text-sm hidden sm:block"></span>
      </div>
      <button id="nextBtn" class="px-5 py-2 bg-primary-600 rounded-md hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 flex items-center gap-2 shadow-md" disabled aria-label="Next page">
        <span>Next</span>
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </main>

  <footer class="mt-auto py-6 text-gray-500 text-sm text-center max-w-6xl w-full select-none border-t border-gray-800 animate-fade-in">
    <div class="flex flex-col md:flex-row justify-between items-center">
      <p>Â© 2025 Raki Movie Explorer Pro â€” Not affiliated with TMDb</p>
      <div class="flex gap-4 mt-2 md:mt-0">
        <a href="#" class="hover:text-blue-400 transition-colors" id="aboutBtn">About</a>
        <a href="#" class="hover:text-blue-400 transition-colors" id="privacyBtn">Privacy</a>
        <a href="https://www.themoviedb.org/" target="_blank" class="hover:text-blue-400 transition-colors">TMDb</a>
      </div>
    </div>
  </footer>

  <!-- Movie Details Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50 p-4 animate-fade-in" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto modal-content p-6 relative shadow-xl animate-slide-up">
      <button id="modalCloseBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white focus:outline-none text-2xl" aria-label="Close modal" title="Close">&times;</button>
      
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Movie poster -->
        <div class="w-full lg:w-1/3 flex-shrink-0">
          <div id="modalPoster" class="w-full h-96 lg:h-full rounded-lg bg-gray-700 flex items-center justify-center overflow-hidden">
            <i class="fas fa-film text-5xl text-gray-500"></i>
          </div>
        </div>
        
        <!-- Movie details -->
        <div class="flex-grow">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <h2 id="modalTitle" class="text-2xl md:text-3xl font-bold mr-2"></h2>
            <span id="modalYear" class="text-gray-400"></span>
            <span id="modalRuntime" class="text-gray-400 flex items-center gap-1">
              <i class="fas fa-clock text-sm"></i>
              <span id="runtimeText"></span>
            </span>
            <span id="modalCertification" class="px-2 py-1 rounded bg-gray-700 text-xs font-semibold"></span>
          </div>
          
          <div class="flex flex-wrap gap-3 mb-4" id="modalGenres"></div>
          
          <div class="flex items-center gap-4 mb-6">
            <div class="flex items-center gap-2">
              <div id="modalRating" class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center border-2 border-yellow-400">
                <span class="font-bold text-yellow-400"></span>
              </div>
              <span class="text-sm text-gray-300">User Score</span>
            </div>
            
            <button id="favToggleBtn" class="px-4 py-2 bg-secondary-500 rounded-md hover:bg-secondary-600 transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-400 flex items-center gap-2">
              <i class="fas fa-star"></i>
              <span>Add to Favorites</span>
            </button>
            
            <button id="watchTrailerBtn" class="px-4 py-2 bg-primary-600 rounded-md hover:bg-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 flex items-center gap-2">
              <i class="fas fa-play"></i>
              <span>Trailer</span>
            </button>
          </div>
          
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Overview</h3>
            <p id="modalOverview" class="text-gray-300 whitespace-pre-line"></p>
          </div>
          
          <div id="modalCast" class="mb-6 hidden">
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Top Cast</h3>
            <div class="flex overflow-x-auto gap-4 pb-2" id="castContainer"></div>
          </div>
          
          <div id="modalTrailer" class="mb-6 hidden">
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Trailer</h3>
            <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden bg-black">
              <!-- Trailer iframe will be inserted here -->
            </div>
          </div>
          
          <div id="modalSimilar" class="hidden">
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Similar Movies</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" id="similarContainer"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div id="aboutModal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50 p-4" role="dialog" aria-modal="true">
    <div class="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6 relative shadow-xl animate-slide-up">
      <button class="absolute top-4 right-4 text-gray-400 hover:text-white focus:outline-none text-2xl" onclick="document.getElementById('aboutModal').classList.add('hidden')">&times;</button>
      <h2 class="text-2xl font-bold mb-4">About Raki Movie Explorer Pro</h2>
      <div class="space-y-4 text-gray-300">
        <p>This application uses the TMDb API but is not endorsed or certified by TMDb.</p>
        <p>Raki Movie Explorer Pro is a fan-made application designed to help you discover and organize your favorite movies.</p>
        <p>Features include:</p>
        <ul class="list-disc pl-6 space-y-2">
          <li>Search and browse thousands of movies</li>
          <li>Save favorites to your local storage</li>
          <li>View detailed movie information</li>
          <li>Watch trailers</li>
          <li>Filter by genres and sort by various criteria</li>
        </ul>
        <p class="pt-4">Version: 2.0.0</p>
      </div>
    </div>
  </div>

<script>
  const API_KEY = '0507e6d3dd7b3ec6761946feeab16d97'; 
  const BASE_URL = 'https://api.themoviedb.org/3';
  const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
  const YOUTUBE_URL = 'https://www.youtube.com/embed/';

  // DOM Elements
  const searchInput = document.getElementById('searchInput');
  const moviesGrid = document.getElementById('moviesGrid');
  const loading = document.getElementById('loading');
  const noResults = document.getElementById('noResults');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageInfo = document.getElementById('pageInfo');
  const totalPages = document.getElementById('totalPages');
  const toggleThemeBtn = document.getElementById('toggleTheme');
  const modal = document.getElementById('modal');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const modalTitle = document.getElementById('modalTitle');
  const modalYear = document.getElementById('modalYear');
  const modalRuntime = document.getElementById('modalRuntime');
  const modalCertification = document.getElementById('modalCertification');
  const modalOverview = document.getElementById('modalOverview');
  const modalPoster = document.getElementById('modalPoster');
  const modalRating = document.getElementById('modalRating');
  const modalGenres = document.getElementById('modalGenres');
  const modalTrailer = document.getElementById('modalTrailer');
  const modalCast = document.getElementById('modalCast');
  const modalSimilar = document.getElementById('modalSimilar');
  const castContainer = document.getElementById('castContainer');
  const similarContainer = document.getElementById('similarContainer');
  const favToggleBtn = document.getElementById('favToggleBtn');
  const watchTrailerBtn = document.getElementById('watchTrailerBtn');
  const showFavoritesBtn = document.getElementById('showFavoritesBtn');
  const clearSearchBtn = document.getElementById('clearSearchBtn');
  const popularLink = document.getElementById('popularLink');
  const genreFilterBtn = document.getElementById('genreFilterBtn');
  const genreDropdown = document.getElementById('genreDropdown');
  const sortSelect = document.getElementById('sortSelect');
  const statsBar = document.getElementById('statsBar');
  const totalResults = document.getElementById('totalResults');
  const searchTime = document.getElementById('searchTime');
  const yearRange = document.getElementById('yearRange');
  const aboutBtn = document.getElementById('aboutBtn');
  const aboutModal = document.getElementById('aboutModal');
  const quickSearchBtn = document.getElementById('quickSearchBtn');

  // App state
  let currentPage = 1;
  let currentQuery = '';
  let currentTotalPages = 1;
  let currentTotalResults = 0;
  let currentMovie = null;
  let currentGenres = [];
  let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
  let genres = [];
  let searchStartTime = 0;
  let isShowingFavorites = false;

  // Initialize the app
  async function init() {
    fetchGenres();
    fetchMovies();
    setupEventListeners();
    updateThemeIcon();
  }

  // Fetch movie genres from TMDb
  async function fetchGenres() {
    try {
      const response = await fetch(`${BASE_URL}/genre/movie/list?api_key=${API_KEY}&language=en-US`);
      const data = await response.json();
      genres = data.genres;
      populateGenreDropdown();
    } catch (error) {
      console.error('Error fetching genres:', error);
    }
  }

  // Populate genre dropdown
  function populateGenreDropdown() {
    genreDropdown.innerHTML = '';
    
    const allItem = document.createElement('div');
    allItem.className = 'px-4 py-2 hover:bg-gray-700 cursor-pointer flex items-center justify-between';
    allItem.innerHTML = `
      <span>All Genres</span>
      <i class="fas fa-check text-blue-400 ${currentGenres.length === 0 ? '' : 'hidden'}"></i>
    `;
    allItem.addEventListener('click', () => {
      currentGenres = [];
      fetchMovies(currentQuery, 1);
      updateGenreDropdown();
    });
    genreDropdown.appendChild(allItem);
    
    genres.forEach(genre => {
      const item = document.createElement('div');
      item.className = 'px-4 py-2 hover:bg-gray-700 cursor-pointer flex items-center justify-between';
      item.innerHTML = `
        <span>${genre.name}</span>
        <i class="fas fa-check text-blue-400 ${currentGenres.includes(genre.id) ? '' : 'hidden'}"></i>
      `;
      item.addEventListener('click', () => {
        toggleGenre(genre.id);
        fetchMovies(currentQuery, 1);
        updateGenreDropdown();
      });
      genreDropdown.appendChild(item);
    });
  }

  // Toggle genre selection
  function toggleGenre(genreId) {
    const index = currentGenres.indexOf(genreId);
    if (index >= 0) {
      currentGenres.splice(index, 1);
    } else {
      currentGenres.push(genreId);
    }
  }

  // Update genre dropdown checkmarks
  function updateGenreDropdown() {
    const items = genreDropdown.querySelectorAll('div');
    items.forEach((item, index) => {
      if (index === 0) {
        // "All Genres" item
        const icon = item.querySelector('i');
        icon.classList.toggle('hidden', currentGenres.length !== 0);
      } else {
        const genre = genres[index - 1];
        const icon = item.querySelector('i');
        icon.classList.toggle('hidden', !currentGenres.includes(genre.id));
      }
    });
  }

  // Fetch movies from TMDb
  async function fetchMovies(query = '', page = 1) {
    isShowingFavorites = false;
    loading.classList.remove('hidden');
    noResults.classList.add('hidden');
    moviesGrid.innerHTML = '';
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    pageInfo.textContent = '';
    totalPages.textContent = '';
    statsBar.classList.add('hidden');
    
    searchStartTime = performance.now();
    
    let url;
    const sortBy = sortSelect.value;
    
    if (query.trim() === '') {
      if (currentGenres.length > 0) {
        url = `${BASE_URL}/discover/movie?api_key=${API_KEY}&language=en-US&sort_by=${sortBy}&page=${page}&with_genres=${currentGenres.join(',')}`;
      } else {
        url = `${BASE_URL}/movie/popular?api_key=${API_KEY}&language=en-US&page=${page}`;
      }
    } else {
      url = `${BASE_URL}/search/movie?api_key=${API_KEY}&language=en-US&query=${encodeURIComponent(query)}&page=${page}&include_adult=false`;
      if (currentGenres.length > 0) {
        url += `&with_genres=${currentGenres.join(',')}`;
      }
    }
    
    try {
      const res = await fetch(url);
      const data = await res.json();
      
      const searchEndTime = performance.now();
      const searchDuration = ((searchEndTime - searchStartTime) / 1000).toFixed(2);
      
      if (data.results && data.results.length > 0) {
        displayMovies(data.results);
        currentTotalPages = data.total_pages;
        currentTotalResults = data.total_results;
        currentPage = data.page;
        currentQuery = query;
        
        // Update pagination
        pageInfo.textContent = `Page ${currentPage}`;
        totalPages.textContent = `of ${currentTotalPages}`;
        totalPages.classList.remove('hidden');
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= currentTotalPages;
        
        // Update stats bar
        totalResults.textContent = `${data.total_results.toLocaleString()} ${data.total_results === 1 ? 'movie' : 'movies'} found`;
        searchTime.textContent = `${searchDuration}s`;
        
        // Calculate year range
        const years = data.results.map(movie => {
          return movie.release_date ? parseInt(movie.release_date.split('-')[0]) : null;
        }).filter(year => year !== null);
        
        if (years.length > 0) {
          const minYear = Math.min(...years);
          const maxYear = Math.max(...years);
          yearRange.textContent = minYear === maxYear ? `${minYear}` : `${minYear} - ${maxYear}`;
        } else {
          yearRange.textContent = 'All years';
        }
        
        statsBar.classList.remove('hidden');
      } else {
        noResults.classList.remove('hidden');
      }
    } catch (error) {
      noResults.textContent = 'Error loading movies. Please try again later.';
      noResults.classList.remove('hidden');
      console.error('Error fetching movies:', error);
    } finally {
      loading.classList.add('hidden');
    }
  }

  // Display movies in grid
  function displayMovies(movies) {
    moviesGrid.innerHTML = '';
    
    movies.forEach(movie => {
      const {
        title,
        poster_path,
        backdrop_path,
        vote_average,
        release_date,
        overview,
        id,
        genre_ids
      } = movie;
      
      const releaseYear = release_date ? release_date.split('-')[0] : 'N/A';
      const rating = vote_average ? vote_average.toFixed(1) : 'N/A';
      const ratingColor = getRatingColor(vote_average);
      
      const card = document.createElement('article');
      card.className = 'movie-card bg-gray-800 rounded-lg overflow-hidden shadow-md flex flex-col cursor-pointer h-full animate-fade-in';
      card.setAttribute('role', 'button');
      card.setAttribute('aria-label', `View details for ${title}`);
      card.setAttribute('tabindex', '0');
      
      card.innerHTML = `
        <div class="relative">
          ${poster_path ? 
            `<img src="${IMAGE_BASE_URL}${poster_path}" alt="${title} poster" class="w-full h-72 object-cover" loading="lazy">` : 
            `<div class="w-full h-72 bg-gray-700 flex items-center justify-center text-gray-500">
              <i class="fas fa-film text-4xl"></i>
            </div>`
          }
          <div class="${ratingColor} rating-badge" title="Rating: ${rating}/10">
            ${rating}
          </div>
        </div>
        <div class="p-4 flex flex-col flex-grow">
          <h3 class="text-lg font-semibold mb-1 line-clamp-2" title="${title}">${title}</h3>
          <p class="text-sm text-gray-400 mb-2">${releaseYear}</p>
          <div class="flex flex-wrap gap-1 mb-3">
            ${genre_ids.slice(0, 3).map(id => {
              const genre = genres.find(g => g.id === id);
              return genre ? `<span class="text-xs px-2 py-1 bg-gray-700 rounded-full">${genre.name}</span>` : '';
            }).join('')}
          </div>
          <p class="text-gray-300 text-sm line-clamp-3 flex-grow">${overview || 'No description available.'}</p>
          <div class="mt-4 flex justify-between items-center">
            <span class="text-xs text-gray-500">ID: ${id}</span>
            <button class="text-blue-400 hover:text-blue-300 text-sm font-medium focus:outline-none">
              More info <i class="fas fa-chevron-right ml-1"></i>
            </button>
          </div>
        </div>
      `;
      
      card.addEventListener('click', () => showMovieDetails(movie));
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          showMovieDetails(movie);
        }
      });
      
      moviesGrid.appendChild(card);
    });
  }

  // Show movie details in modal
  async function showMovieDetails(movie) {
    currentMovie = movie;
    modalTitle.textContent = movie.title;
    modalYear.textContent = movie.release_date ? movie.release_date.split('-')[0] : 'N/A';
    modalOverview.textContent = movie.overview || 'No overview available.';
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // Clear previous content
    modalTrailer.classList.add('hidden');
    modalCast.classList.add('hidden');
    modalSimilar.classList.add('hidden');
    modalTrailer.innerHTML = '';
    castContainer.innerHTML = '';
    similarContainer.innerHTML = '';
    
    // Set poster image
    if (movie.poster_path) {
      modalPoster.innerHTML = `<img src="${IMAGE_BASE_URL}${movie.poster_path}" alt="${movie.title} poster" class="w-full h-full object-cover">`;
    } else {
      modalPoster.innerHTML = '<div class="w-full h-full bg-gray-700 flex items-center justify-center text-gray-500"><i class="fas fa-film text-5xl"></i></div>';
    }
    
    // Set rating
    const rating = movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A';
    const ratingColor = getRatingColor(movie.vote_average);
    modalRating.innerHTML = `<span class="font-bold ${ratingColor}">${rating}</span>`;
    
    // Update favorite button
    updateFavButton();
    
    // Fetch additional details
    try {
      const [detailsRes, creditsRes, videosRes, similarRes] = await Promise.all([
        fetch(`${BASE_URL}/movie/${movie.id}?api_key=${API_KEY}&language=en-US`),
        fetch(`${BASE_URL}/movie/${movie.id}/credits?api_key=${API_KEY}&language=en-US`),
        fetch(`${BASE_URL}/movie/${movie.id}/videos?api_key=${API_KEY}&language=en-US`),
        fetch(`${BASE_URL}/movie/${movie.id}/similar?api_key=${API_KEY}&language=en-US&page=1`)
      ]);
      
      const details = await detailsRes.json();
      const credits = await creditsRes.json();
      const videos = await videosRes.json();
      const similar = await similarRes.json();
      
      // Update runtime
      if (details.runtime) {
        const hours = Math.floor(details.runtime / 60);
        const minutes = details.runtime % 60;
        document.getElementById('runtimeText').textContent = `${hours}h ${minutes}m`;
      } else {
        document.getElementById('runtimeText').textContent = 'N/A';
      }
      
      // Update certification
      if (details.release_dates && details.release_dates.results) {
        const usRelease = details.release_dates.results.find(r => r.iso_3166_1 === 'US');
        if (usRelease && usRelease.release_dates.length > 0) {
          modalCertification.textContent = usRelease.release_dates[0].certification || 'NR';
        } else {
          modalCertification.textContent = 'NR';
        }
      } else {
        modalCertification.textContent = 'NR';
      }
      
      // Update genres
      modalGenres.innerHTML = '';
      if (details.genres && details.genres.length > 0) {
        details.genres.slice(0, 3).forEach(genre => {
          const genreEl = document.createElement('span');
          genreEl.className = 'px-3 py-1 bg-gray-700 rounded-full text-sm';
          genreEl.textContent = genre.name;
          modalGenres.appendChild(genreEl);
        });
      }
      
      // Update cast
      if (credits.cast && credits.cast.length > 0) {
        modalCast.classList.remove('hidden');
        const topCast = credits.cast.slice(0, 10);
        topCast.forEach(person => {
          const castItem = document.createElement('div');
          castItem.className = 'flex-shrink-0 w-24 text-center';
          castItem.innerHTML = `
            <div class="w-16 h-16 rounded-full bg-gray-700 mx-auto mb-2 overflow-hidden">
              ${person.profile_path ? 
                `<img src="${IMAGE_BASE_URL}${person.profile_path}" alt="${person.name}" class="w-full h-full object-cover" loading="lazy">` : 
                `<i class="fas fa-user text-2xl text-gray-500 w-full h-full flex items-center justify-center"></i>`
              }
            </div>
            <p class="text-sm font-medium truncate" title="${person.name}">${person.name}</p>
            <p class="text-xs text-gray-400 truncate" title="${person.character}">${person.character}</p>
          `;
          castContainer.appendChild(castItem);
        });
      }
      
      // Update similar movies
      if (similar.results && similar.results.length > 0) {
        modalSimilar.classList.remove('hidden');
        const similarMovies = similar.results.slice(0, 4);
        similarMovies.forEach(movie => {
          const similarItem = document.createElement('div');
          similarItem.className = 'cursor-pointer';
          similarItem.innerHTML = `
            <div class="aspect-[2/3] bg-gray-700 rounded-lg overflow-hidden mb-2">
              ${movie.poster_path ? 
                `<img src="${IMAGE_BASE_URL}${movie.poster_path}" alt="${movie.title}" class="w-full h-full object-cover" loading="lazy">` : 
                `<i class="fas fa-film text-4xl text-gray-500 w-full h-full flex items-center justify-center"></i>`
              }
            </div>
            <p class="text-sm font-medium truncate" title="${movie.title}">${movie.title}</p>
            <p class="text-xs text-gray-400">${movie.release_date ? movie.release_date.split('-')[0] : 'N/A'}</p>
          `;
          similarItem.addEventListener('click', () => {
            showMovieDetails(movie);
            // Scroll modal to top when changing movies
            modal.querySelector('.modal-content').scrollTop = 0;
          });
          similarContainer.appendChild(similarItem);
        });
      }
      
      // Set up trailer button
      watchTrailerBtn.onclick = () => {
        const trailer = videos.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');
        if (trailer) {
          modalTrailer.innerHTML = `
            <iframe 
              class="w-full aspect-video rounded-lg" 
              src="${YOUTUBE_URL}${trailer.key}?autoplay=1&mute=1" 
              title="${movie.title} trailer" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen>
            </iframe>
          `;
          modalTrailer.classList.remove('hidden');
          // Scroll to trailer
          modalTrailer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          modalTrailer.innerHTML = '<p class="text-gray-400 text-center py-4">No trailer available for this movie.</p>';
          modalTrailer.classList.remove('hidden');
        }
      };
      
    } catch (error) {
      console.error('Error fetching movie details:', error);
    }
  }

  // Get color based on rating
  function getRatingColor(rating) {
    if (!rating) return 'text-gray-400 border-gray-400';
    if (rating >= 8) return 'text-green-400 border-green-400';
    if (rating >= 6) return 'text-yellow-400 border-yellow-400';
    if (rating >= 4) return 'text-orange-400 border-orange-400';
    return 'text-red-400 border-red-400';
  }

  // Update favorite button state
  function updateFavButton() {
    if (!currentMovie) return;
    const isFav = favorites.some(m => m.id === currentMovie.id);
    favToggleBtn.innerHTML = isFav ? 
      '<i class="fas fa-star"></i> Remove from Favorites' : 
      '<i class="far fa-star"></i> Add to Favorites';
    favToggleBtn.className = isFav ? 
      'px-4 py-2 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 flex items-center gap-2' :
      'px-4 py-2 bg-secondary-500 rounded-md hover:bg-secondary-600 transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-400 flex items-center gap-2';
  }

  // Toggle favorite status
  function toggleFavorite() {
    if (!currentMovie) return;
    const index = favorites.findIndex(m => m.id === currentMovie.id);
    if (index >= 0) {
      favorites.splice(index, 1);
    } else {
      favorites.push(currentMovie);
    }
    localStorage.setItem('favorites', JSON.stringify(favorites));
    updateFavButton();
    
    // If we're currently showing favorites, update the view
    if (isShowingFavorites) {
      showFavorites();
    }
  }

  // Show favorite movies
  function showFavorites() {
    isShowingFavorites = true;
    loading.classList.add('hidden');
    noResults.classList.add('hidden');
    moviesGrid.innerHTML = '';
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    pageInfo.textContent = '';
    totalPages.textContent = '';
    statsBar.classList.add('hidden');
    
    if (favorites.length === 0) {
      noResults.textContent = 'You have no favorite movies saved.';
      noResults.classList.remove('hidden');
    } else {
      displayMovies(favorites);
      pageInfo.textContent = 'Your Favorites';
    }
  }

  // Theme handling
  function setTheme(theme) {
    if (theme === 'light') {
      document.body.classList.remove('bg-dark-900', 'text-white');
      document.body.classList.add('bg-white', 'text-gray-900');
      document.body.dataset.theme = 'light';
    } else {
      document.body.classList.remove('bg-white', 'text-gray-900');
      document.body.classList.add('bg-dark-900', 'text-white');
      document.body.dataset.theme = 'dark';
    }
    updateThemeIcon();
    localStorage.setItem('theme', theme);
  }

  // Update theme toggle icon
  function updateThemeIcon() {
    const icon = toggleThemeBtn.querySelector('i');
    if (document.body.dataset.theme === 'dark') {
      icon.classList.replace('fa-sun', 'fa-moon');
      icon.classList.add('text-yellow-400');
    } else {
      icon.classList.replace('fa-moon', 'fa-sun');
      icon.classList.add('text-yellow-500');
    }
  }

  // Setup event listeners
  function setupEventListeners() {
    // Theme toggle
    toggleThemeBtn.addEventListener('click', () => {
      const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });
    
    // Search input
    searchInput.addEventListener('input', debounce((e) => {
      const query = e.target.value.trim();
      if (query.length >= 2 || query.length === 0) {
        fetchMovies(query, 1);
      }
    }, 500));
    
    // Clear search
    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      fetchMovies('', 1);
    });
    
    // Pagination
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        fetchMovies(currentQuery, currentPage - 1);
      }
    });
    
    nextBtn.addEventListener('click', () => {
      if (currentPage < currentTotalPages) {
        fetchMovies(currentQuery, currentPage + 1);
      }
    });
    
    // Favorites
    favToggleBtn.addEventListener('click', toggleFavorite);
    showFavoritesBtn.addEventListener('click', showFavorites);
    
    // Modal
    modalCloseBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
      modalTrailer.innerHTML = '';
    });
    
    // Close modal on outside click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        modalTrailer.innerHTML = '';
      }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        modalTrailer.innerHTML = '';
      }
    });
    
    // Genre filter dropdown
    genreFilterBtn.addEventListener('click', () => {
      genreDropdown.classList.toggle('hidden');
    });
    
    // Close genre dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!genreFilterBtn.contains(e.target) && !genreDropdown.contains(e.target)) {
        genreDropdown.classList.add('hidden');
      }
    });
    
    // Sort select
    sortSelect.addEventListener('change', () => {
      fetchMovies(currentQuery, 1);
    });
    
    // Popular link in no results
    popularLink.addEventListener('click', (e) => {
      e.preventDefault();
      searchInput.value = '';
      fetchMovies('', 1);
    });
    
    // About modal
    aboutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      aboutModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    });
    
    // Quick search button
    quickSearchBtn.addEventListener('click', () => {
      searchInput.focus();
    });
  }

  // Debounce function for search input
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Initialize theme from localStorage or default dark
  setTheme(localStorage.getItem('theme') || 'dark');
  
  // Initialize the app
  init();
</script>
</body>
</html>